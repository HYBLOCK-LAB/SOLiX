version: "3.9"

x-committee-base: &committee-base
  build:
    context: .
    dockerfile: docker/committee.Dockerfile
  env_file:
    - apps/committee/.env
  environment:
    REDIS_URL: redis://redis:6379
    COMMITTEE_INSTANCES: 1
  depends_on:
    redis:
      condition: service_healthy

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  committee-1:
    <<: *committee-base
    container_name: solix-committee-1
    environment:
      COMMITTEE_ID: committee-1
      PORT: 4000
    ports:
      - "4000:4000"

  committee-2:
    <<: *committee-base
    container_name: solix-committee-2
    environment:
      COMMITTEE_ID: committee-2
      PORT: 4000
    ports:
      - "4001:4000"

  committee-3:
    <<: *committee-base
    container_name: solix-committee-3
    environment:
      COMMITTEE_ID: committee-3
      PORT: 4000
    ports:
      - "4002:4000"

  committee-4:
    <<: *committee-base
    container_name: solix-committee-4
    environment:
      COMMITTEE_ID: committee-4
      PORT: 4000
    ports:
      - "4003:4000"

  committee-5:
    <<: *committee-base
    container_name: solix-committee-5
    environment:
      COMMITTEE_ID: committee-5
      PORT: 4000
    ports:
      - "4004:4000"

  license-web:
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/web.Dockerfile
    env_file: apps/web/.env
    ports:
      - "3000:3000"

  contracts-node:
    build:
      context: .
      dockerfile: docker/contracts.Dockerfile
    env_file:
      - apps/on-chain/.env
    ports:
      - "8545:8545"
    restart: unless-stopped

  # relayer:
  #   profiles: ["relayer"]
  #   build:
  #     context: .
  #     dockerfile: docker/relayer.Dockerfile
  #   env_file: .env.relayer
  #   ports:
  #     - "4000:4000"
