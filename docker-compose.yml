version: "3.9"

x-committee-base: &committee-base
  build:
    context: .
    dockerfile: docker/committee.Dockerfile
  env_file:
    - apps/committee/.env
  environment:
    REDIS_URL: redis://redis:6379
    COMMITTEE_INSTANCES: 1
  depends_on:
    redis:
      condition: service_healthy
    committee-role-init:
      condition: service_completed_successfully

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "60", "1", "--loglevel", "warning"]
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s

  committee-1:
    <<: *committee-base
    container_name: solix-committee-1
    env_file:
      - apps/committee/.env
      - apps/committee/.env.committee-1
    environment:
      COMMITTEE_ID: committee-1
      PORT: 4000
    ports:
      - "4000:4000"

  committee-2:
    <<: *committee-base
    container_name: solix-committee-2
    env_file:
      - apps/committee/.env
      - apps/committee/.env.committee-2
    environment:
      COMMITTEE_ID: committee-2
      PORT: 4000
    ports:
      - "4001:4000"

  committee-3:
    <<: *committee-base
    container_name: solix-committee-3
    env_file:
      - apps/committee/.env
      - apps/committee/.env.committee-3
    environment:
      COMMITTEE_ID: committee-3
      PORT: 4000
    ports:
      - "4002:4000"

  committee-4:
    <<: *committee-base
    container_name: solix-committee-4
    env_file:
      - apps/committee/.env
      - apps/committee/.env.committee-4
    environment:
      COMMITTEE_ID: committee-4
      PORT: 4000
    ports:
      - "4003:4000"

  committee-5:
    <<: *committee-base
    container_name: solix-committee-5
    env_file:
      - apps/committee/.env
      - apps/committee/.env.committee-5
    environment:
      COMMITTEE_ID: committee-5
      PORT: 4000
    ports:
      - "4004:4000"

  license-web:
    platform: linux/amd64
    build:
      context: .
      dockerfile: docker/web.Dockerfile
    env_file: apps/web/.env
    ports:
      - "3000:3000"

  contracts-node:
    build:
      context: .
      dockerfile: docker/contracts.Dockerfile
    env_file:
      - apps/on-chain/.env
    ports:
      - "8545:8545"
    restart: unless-stopped

  # relayer:
  #   profiles: ["relayer"]
  #   build:
  #     context: .
  #     dockerfile: docker/relayer.Dockerfile
  #   env_file: .env.relayer
  #   ports:
  #     - "4000:4000"
  committee-role-init:
    build:
      context: .
      dockerfile: docker/contracts.Dockerfile
    env_file:
      - apps/on-chain/.env
      - apps/committee/.env.committee.role
    command:
      - /bin/sh
      - -c
      - |
        if [ -z "$$COMMITTEE_ROLE_ADDRESSES" ]; then
          echo "COMMITTEE_ROLE_ADDRESSES not set. Skipping role grant."
          exit 0
        fi
        if [ -z "$$COMMITTEE_MANAGER_ADDRESS" ]; then
          echo "COMMITTEE_MANAGER_ADDRESS is required for committee-role-init" >&2
          exit 1
        fi
        echo "Granting COMMITTEE_ROLE to: $$COMMITTEE_ROLE_ADDRESSES"
        npx hardhat run --network "$${COMMITTEE_ROLE_NETWORK:-sepolia}" scripts/grant-committee-role.ts
    restart: "no"
